[(#REM)

  Squelette
  (c) 2009 xxx
  Distribue sous licence GPL

]
<?php

echo "<h1>TextWheel</h1>";
echo "<p>";
if (_request('var_debug_wheel')) {
	echo "<a href='" . parametre_url(self(), 'var_debug_wheel', ''). "'>Enlever le mode debug</a>";
} else {
	echo "<a href='" . parametre_url(self(), 'var_debug_wheel', '1'). "'>Activer le mode debug</a>";
}
echo " | <a href='" . self() . "'>Actualiser</a></p>";

$notes = charger_fonction('notes', 'inc');
include_spip('tw_texte');
include_spip('inc/diff');
include_spip('inc/revisions');

if (_request('id_article'))
	$w = " WHERE id_article=".intval(_request('id_article'));
$s = spip_query('SELECT * FROM spip_articles'.$w.' LIMIT 0,1000');

$erreurs = 10;
$success = 0;
$time_propre = $time_tw = 0;
while ($t = sql_fetch($s)) {
	propre($t['texte']); // a blanc, pour faire les inits communes mais seulement si pas de memoization

	$notes('','reset_all');
	spip_timer('tw');
	$tw = tw_propre($t['texte']);
	$time_tw +=spip_timer('tw',true);
	
	$notes('','reset_all');
	spip_timer('propre');
	$pr = propre($t['texte']);
	$time_propre+=spip_timer('propre',true);


	if ($tw === $pr)
		$success++;
		//echo "<li>article $t[id_article] OK</li>\n";
	else {
		echo "<li>article $t[id_article] <b>NOK</b>";
		if (_request('id_article') != $t['id_article'])
			echo " <a href='?exec=tw&amp;id_article=$t[id_article]'>afficher</a>";
		echo "</li>\n";
		if (!$erreurs--) break;
	}

	if (_request('id_article')) {
		include_spip('inc/suivi_versions');
		$diff = new Diff(new DiffTexte);
		$n = preparer_diff(str_replace('<','&#60;',$tw));
		$o = preparer_diff(str_replace('<','&#60;',$pr));
		echo "<h4>diff (en vert, textwheel, en rouge, propre):</h4><div>".afficher_para_modifies(afficher_diff($diff->comparer($n,$o)))."</div>\n";

		echo "<h4>source:</h4> <textarea style='width:100%;height:300px'>".entites_html($t['texte'])."</textarea>\n";
		echo "<h4>propre:</h4> <textarea style='width:100%;height:300px'>".entites_html($pr)."</textarea>\n";
		echo "<h4>textwheel:</h4> <textarea style='width:100%;height:300px'>".entites_html($tw)."</textarea>\n";
	}

}

echo "$success articles compares avec succes";
echo "<br />Temps total Propre : $time_propre";
echo "<br />Temps total TextWheel : $time_tw";
echo "<br />Ecart : ".round(100*$time_tw/$time_propre-100,1)."%";

TextWheelDebug::outputDebug();

?>
