[(#REM)

  Squelette
  (c) 2009 xxx
  Distribue sous licence GPL

]
<style type='text/css'>
table.spip.stats {margin:1em 0;}
table.spip.stats tr:hover {background:white;}
table.spip.stats {border:1px solid #888; width:80%;}
table.spip.stats th, table.spip.stats td{border:0;}
.tw_erreur {margin:1em 0; padding:.5em; background:#fff; border:1px solid #ff7f00;}
.tw_erreur li {margin-left:1em;}
</style>
<script type='text/javascript'>
$(document).ready(function(){
	$('.textwheeldebug table')
		.addClass('spip stats')
		.find('tbody tr').addClass('row_odd')
		.parent().find('tr:nth-child(2n+1)').addClass('row_even');
});
</script>

<h1>TextWheel</h1>
<p class='actions'>
	[(#ENV{var_debug_wheel}|?{
		<a href="[(#SELF|parametre_url{var_debug_wheel,''})]">Enlever le mode debug</a>,
		<a href="[(#SELF|parametre_url{var_debug_wheel,1})]">Activer le mode debug</a>
	})]
	<span class='sep'>|</span>
	<a href="[(#SELF|parametre_url{var_debug_wheel,[(#ENV{var_debug_wheel}|?{1,''})]})]">Actualiser</a>
	[(#ENV{id_article}|oui)
		<span class='sep'>|</span>
		<a href="[(#SELF|parametre_url{var_debug_wheel,[(#ENV{var_debug_wheel}|?{1,''})]}|parametre_url{id_article,''})]">Retour</a>
	]
</p>

<?php

$notes = charger_fonction('notes', 'inc');
include_spip('tw_texte');
include_spip('inc/diff');
include_spip('inc/revisions');

if (_request('id_article'))
	$w = " WHERE id_article=".intval(_request('id_article'));
$s = spip_query('SELECT * FROM spip_articles'.$w.' LIMIT 0,1000');


// faire les inits communes
$init = 'oh la la';
propre($init);
tw_propre($init);


$erreurs = 10;
$success = 0;
$time_propre = $time_tw = 0;
$lien = parametre_url(self(), 'var_debug_wheel', _request('var_debug_wheel'));
$erreur_open = false;

while ($t = sql_fetch($s)) {
	$notes('','reset_all');
	spip_timer('tw');
	$tw = tw_propre($t['texte']);
	$time_tw +=spip_timer('tw',true);
	
	$notes('','reset_all');
	spip_timer('propre');
	$pr = propre($t['texte']);
	$time_propre+=spip_timer('propre',true);


	if ($tw === $pr)
		$success++;
		//echo "<li>article $t[id_article] OK</li>\n";
	else {
		if (!$erreur_open) {
			$erreur_open = true;
			echo "<ul class='tw_erreur'>";
		}
		echo "<li>article $t[id_article] <b>NOK</b>";
		if (_request('id_article') != $t['id_article'])
			echo " <a href='$lien&amp;id_article=$t[id_article]'>afficher</a>";
		echo "</li>\n";
		if (!$erreurs--) {
			echo "</ul>";
			break;
		}
	}

	if (_request('id_article')) {
		include_spip('inc/suivi_versions');
		$diff = new Diff(new DiffTexte);
		$n = preparer_diff(str_replace('<','&#60;',$tw));
		$o = preparer_diff(str_replace('<','&#60;',$pr));
		echo "<h4>diff (en vert, textwheel, en rouge, propre):</h4><div>".afficher_para_modifies(afficher_diff($diff->comparer($n,$o)))."</div>\n";

		echo "<h4>source:</h4> <textarea style='width:100%;height:300px'>".entites_html($t['texte'])."</textarea>\n";
		echo "<h4>propre:</h4> <textarea style='width:100%;height:300px'>".entites_html($pr)."</textarea>\n";
		echo "<h4>textwheel:</h4> <textarea style='width:100%;height:300px'>".entites_html($tw)."</textarea>\n";
	}

}
if ($erreur_open) { echo "</ul>"; }

echo "
<table class='spip stats'>
	<caption>Statistiques Globales</caption>
	<tr class='row_odd'>
		<td>Articles compares avec succes :</td>
		<td>$success</td>
	 </tr>
	<tr class='row_even'>
		<td>Temps total Propre :</td>
		<td>".round($time_propre)."&nbsp;ms</td>
	</tr>
	<tr class='row_odd'>
		<td>Temps total TextWheel :</td>
		<td>".round($time_tw)."&nbsp;ms</td>
	 </tr>
	<tr class='row_even'>
		<td>Ecart :</td>
		<td>".round(100*$time_tw/$time_propre-100,1)."%</td>
	</tr>
</table>";

TextWheelDebug::outputDebug();


?>
